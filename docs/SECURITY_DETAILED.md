# 보안 처리 코드 위치 및 동작 흐름

## 🗺️ 코드 맵

```
프로젝트 구조
├── lib/auth.ts                              ← JWT 암호화, 세션 설정
├── app/api/auth/register/route.ts           ← 비밀번호 해싱 (bcrypt)
├── app/api/auth/[...nextauth]/route.ts      ← CSRF 보호 (자동)
├── app/auth/login/page.tsx                  ← 로그인 폼 (CSRF 자동 포함)
├── app/auth/register/page.tsx               ← 회원가입 폼
└── app/api/user/profile/route.ts            ← 보호된 API
```

---

## 1️⃣ JWT 토큰 암호화

### 📄 코드 위치: `lib/auth.ts` (라인 51-56)

```typescript
session: {
  strategy: "jwt",                              // JWT 전략 사용
  maxAge: 30 * 24 * 60 * 60                    // 30일 후 자동 만료
},
secret: process.env.NEXTAUTH_SECRET            // 비밀키로 암호화 🔐
```

### 🔄 동작 흐름

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 사용자 로그인                                              │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. JWT 콜백 실행 (lib/auth.ts - 라인 42-48)                  │
│                                                              │
│  callbacks: {                                                │
│    async jwt({ token, user }) {                              │
│      if (user) {                                              │
│        token.id = user.id;    // 토큰에 사용자 정보 추가       │
│        token.email = user.email;                              │
│        token.name = user.name;                                │
│      }                                                         │
│      return token;  // ← 토큰 생성                            │
│    }                                                          │
│  }                                                            │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. 토큰 암호화 (내부 처리)                                    │
│                                                              │
│  NEXTAUTH_SECRET으로 암호화:                                  │
│  "my-super-secret-key" + JWT 내용                            │
│           ↓                                                   │
│  암호화된 토큰: eyJhbGc...SflKxw...                           │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. 쿠키에 저장                                                │
│                                                              │
│  Set-Cookie: next-auth.session-token=eyJhbGc...             │
│              HttpOnly; Secure; SameSite=Lax;                 │
│              Max-Age=2592000                                 │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. 다음 요청 시 자동으로 포함됨                               │
│                                                              │
│  GET /api/user/profile                                       │
│  Cookie: next-auth.session-token=eyJhbGc...                 │
│           ↓                                                   │
│  NextAuth가 토큰 자동 검증                                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 2️⃣ bcrypt 비밀번호 해싱

### 📄 코드 위치: `app/api/auth/register/route.ts` (라인 39)

```typescript
import bcrypt from "bcryptjs";

// 회원가입 시
const hashedPassword = await bcrypt.hash(password, 10);
//                                       ↑     ↑
//                                    평문   salt rounds
```

### 🔄 동작 흐름

```
┌─────────────────────────────────────────────────────────────┐
│ 회원가입 요청                                                 │
│ POST /api/auth/register                                      │
│ { email: "user@example.com", password: "mypass123" }        │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 1단계: 유효성 검사 (라인 13-23)                               │
│                                                              │
│  if (!email || !password || !name) return error;            │
│  if (password.length < 6) return error;                     │
│                                                              │
│  ✅ 통과                                                     │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 2단계: 기존 사용자 확인 (라인 26-33)                           │
│                                                              │
│  const existingUser = await prisma.user.findUnique(...)    │
│  if (existingUser) return "이미 가입된 이메일";              │
│                                                              │
│  ✅ 새로운 사용자                                             │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 3단계: 비밀번호 해싱 🔐 (라인 39)                             │
│                                                              │
│  const hashedPassword = await bcrypt.hash(password, 10);   │
│                                                              │
│  입력: "mypass123"                                           │
│       ↓                                                       │
│  bcrypt 알고리즘 실행 (10번 반복)                             │
│       ↓                                                       │
│  출력: "$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7b3..."        │
│                                                              │
│  특징:                                                       │
│  • 일방향 (복호화 불가능)                                    │
│  • 매번 다른 해시 생성 (같은 입력도)                         │
│  • 느린 계산 (공격자에게 불리)                               │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 4단계: DB에 저장 (라인 42-49)                                │
│                                                              │
│  const user = await prisma.user.create({                   │
│    data: {                                                   │
│      email,                                                  │
│      name,                                                   │
│      password: hashedPassword  // ← 해시만 저장 🔐          │
│    }                                                         │
│  });                                                         │
│                                                              │
│  DB에 저장되는 것:                                            │
│  email     | name | password                                │
│  ────────────────────────────────────────────────────────   │
│  user@...  | 김철 | $2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAg... │
│                  ↑ 평문 저장 불가능 ↑                       │
└─────────────────────────────────────────────────────────────┘
```

### 로그인 시 비밀번호 검증

📄 코드 위치: `lib/auth.ts` (라인 29-31)

```typescript
const isPasswordValid = await bcrypt.compare(
  credentials.password, // "mypass123" (사용자 입력)
  user.password // "$2a$10$N9qo8..." (DB 해시)
);
```

```
┌─────────────────────────────────────────────────────────────┐
│ 로그인 요청                                                  │
│ { email: "user@example.com", password: "mypass123" }       │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 1. DB에서 사용자 조회                                        │
│                                                              │
│  const user = await prisma.user.findUnique(...)            │
│  user.password = "$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAg..."  │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. bcrypt.compare() 실행                                    │
│                                                              │
│  bcrypt.compare("mypass123", "$2a$10$N9qo8...")           │
│          ↓                                                   │
│  입력값을 같은 소금(salt)으로 해싱                            │
│          ↓                                                   │
│  결과 해시 == DB 해시?                                       │
│          ↓                                                   │
│  YES → true (로그인 성공)                                    │
│  NO  → false (비밀번호 불일치)                              │
│                                                              │
│  ✅ 안전: 원본 비밀번호 노출 없음                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 3️⃣ CSRF 보호

### 📄 자동 처리 위치: `app/api/auth/[...nextauth]/route.ts`

```typescript
import NextAuth from "next-auth";
import { authOptions } from "@/lib/auth";

const handler = NextAuth(authOptions); // ← CSRF 토큰 자동 생성
export { handler as GET, handler as POST };
```

### 🔄 동작 흐름

```
시나리오: 악의적 웹사이트에서 당신의 계정으로 로그인 시도

┌─────────────────────────────────────────────────────────────┐
│ 1. 악의적 웹사이트                                           │
│    <form action="https://mystore.com/api/auth/signin">     │
│      <input name="email" value="attacker@example.com">     │
│      <input name="password" value="attacker_pass">         │
│    </form>                                                  │
│                                                              │
│    (사용자의 쿠키가 자동으로 포함됨)                         │
└─────────────────────────────────────────────────────────────┘
         ↓ 요청 전송
┌─────────────────────────────────────────────────────────────┐
│ 2. NextAuth가 CSRF 토큰 확인                                │
│                                                              │
│  if (request.csrf !== cookies.csrf_token) {                │
│    return error("Invalid CSRF token");                      │
│  }                                                           │
│                                                              │
│  악의적 웹사이트는 토큰을 모르므로:                          │
│  ❌ CSRF 토큰 불일치 → 요청 거부                            │
│                                                              │
│  ✅ 보호됨! 계정 도용 방지                                   │
└─────────────────────────────────────────────────────────────┘
```

### 정상적인 로그인 요청

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 로그인 페이지 로드 (app/auth/login/page.tsx)             │
│                                                              │
│  GET /auth/login                                            │
│   ↓                                                          │
│  NextAuth가 CSRF 토큰 생성                                   │
│   ↓                                                          │
│  쿠키에 저장: _csrf=abc123xyz...                            │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. 사용자가 로그인 폼 제출 (라인 42-47)                       │
│                                                              │
│  const result = await signIn('credentials', {              │
│    email,                                                   │
│    password,                                                │
│    redirect: false                                          │
│  });                                                        │
│                                                              │
│  NextAuth가 자동으로:                                        │
│  • CSRF 토큰을 요청에 포함                                  │
│  • signIn 함수가 쿠키에서 토큰 추출                         │
│  • Authorization 헤더에 추가                                 │
└─────────────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. 서버에서 검증                                            │
│                                                              │
│  POST /api/auth/signin                                      │
│  Headers: {                                                 │
│    "x-csrf-token": "abc123xyz..."  // ← 자동 포함           │
│  }                                                           │
│   ↓                                                          │
│  서버가 토큰 확인                                            │
│   ↓                                                          │
│  ✅ 토큰 일치 → 로그인 진행                                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 4️⃣ 안전한 쿠키 관리

### 📄 자동 설정 위치: NextAuth.js 기본 설정

```typescript
// 실제로는 이렇게 설정됨 (내부적으로)
cookies: {
  sessionToken: {
    name: `next-auth.session-token`,
    options: {
      httpOnly: true,      // JavaScript에서 접근 불가 🔐
      sameSite: "lax",     // 크로스 사이트 요청 방지
      path: "/",
      secure: true,        // HTTPS only (프로덕션)
      maxAge: 30 * 24 * 60 * 60  // 30일
    }
  }
}
```

### 🔄 쿠키 보안 옵션 설명

```
┌──────────────────────────────────────────────────────────────┐
│ HttpOnly 옵션                                               │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ ❌ document.cookie 접근 불가능                              │
│    (XSS 공격으로 토큰 탈취 방지)                             │
│                                                              │
│ ✅ 네트워크 요청 시만 자동으로 포함됨                         │
│                                                              │
│ 예: GET /api/user/profile                                   │
│     ↓                                                         │
│     쿠키 자동 포함 (서버만 접근 가능)                        │
│                                                              │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│ SameSite 옵션                                                │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ 값: "lax", "strict", "none"                                 │
│                                                              │
│ "lax" (기본값):                                              │
│ • 같은 사이트 요청: 쿠키 포함 ✅                             │
│ • 크로스 사이트 POST: 쿠키 제외 ❌ (CSRF 방지)              │
│ • 크로스 사이트 GET (링크): 쿠키 포함 ✅                    │
│                                                              │
│ CSRF 공격 시나리오:                                          │
│ 악의적 사이트 POST form                                      │
│         ↓                                                     │
│ mystore.com으로 요청 (쿠키 제외)                             │
│         ↓                                                     │
│ ✅ 로그인 상태로 악성 요청 실행 불가                         │
│                                                              │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│ Secure 옵션                                                  │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ ✅ HTTPS 연결에서만 전송됨                                   │
│ ❌ HTTP 연결에서 전송 안 됨 (중간자 공격 방지)               │
│                                                              │
│ 개발: http://localhost → Secure 안 함 (자동 무시)           │
│ 프로덕션: https://yourdomain.com → Secure 적용             │
│                                                              │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│ MaxAge 옵션                                                  │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ 30 * 24 * 60 * 60 = 2,592,000초 = 30일                     │
│                                                              │
│ 30일 후:                                                     │
│ • 쿠키 자동 삭제                                             │
│ • 사용자 자동 로그아웃                                       │
│ • 새로 로그인 필요                                           │
│                                                              │
│ (보안 최적화: 더 짧게 설정 가능 예: 7일)                    │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## 📊 종합 보안 흐름

```
┌────────────────────────────────────────────────────────────────┐
│                    회원가입 → 로그인 → API 호출                  │
└────────────────────────────────────────────────────────────────┘

1️⃣ 회원가입 (/auth/register)
   ├─ "password123" 입력
   ├─ bcrypt.hash() → "$2a$10$..." (해시)
   └─ DB에 저장 (평문 불가능) 🔐

2️⃣ 로그인 (/auth/login)
   ├─ "password123" 입력
   ├─ bcrypt.compare() → 해시 검증
   ├─ JWT 토큰 생성
   ├─ NEXTAUTH_SECRET으로 암호화 🔐
   └─ HttpOnly 쿠키에 저장

3️⃣ API 호출 (/api/user/profile)
   ├─ 요청 헤더에 쿠키 자동 포함
   ├─ 서버가 쿠키 검증
   ├─ getServerSession() → 사용자 정보 추출
   └─ ✅ 인증된 요청 처리

4️⃣ CSRF 공격 시도
   ├─ 악의적 웹사이트에서 요청
   ├─ CSRF 토큰 없음 또는 불일치
   └─ ❌ 요청 거부 (안전)
```

---

## 🎓 핵심 정리

| 보안 기능    | 방식               | 효과                    |
| ------------ | ------------------ | ----------------------- |
| **bcrypt**   | 단방향 해싱        | 평문 비밀번호 저장 불가 |
| **JWT**      | 토큰 암호화        | 토큰 위조 불가능        |
| **CSRF**     | 토큰 검증          | 악의적 요청 차단        |
| **HttpOnly** | JavaScript 차단    | XSS 공격 방지           |
| **Secure**   | HTTPS only         | 중간자 공격 방지        |
| **SameSite** | 크로스 사이트 제한 | CSRF 공격 방지          |

---

**현재 보안 수준: ⭐⭐⭐⭐ (매우 안전함) 🔒**

┌─────────────────────────────────────────────┐
│ NextAuth.js 내부에서 자동 처리 │
├─────────────────────────────────────────────┤
│ │
│ ✅ JWT 생성 & 암호화 │
│ ✅ 쿠키 설정 (HttpOnly, Secure, ...) │
│ ✅ CSRF 토큰 생성 & 검증 │
│ ✅ 세션 유효성 검증 │
│ ✅ 토큰 자동 갱신 │
│ ✅ 로그아웃 (쿠키 삭제) │
│ ✅ 사용자 정보 추출 │
│ │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 우리가 직접 작성한 코드 │
├─────────────────────────────────────────────┤
│ │
│ 1️⃣ lib/auth.ts │
│ • CredentialsProvider 설정 │
│ • callbacks (jwt, session) 정의 │
│ • authorize() 비밀번호 검증 │
│ │
│ 2️⃣ app/api/auth/register/route.ts │
│ • 회원가입 로직 (DB 저장) │
│ • bcrypt 해싱 │
│ │
│ 3️⃣ app/api/user/profile/route.ts │
│ • getServerSession() 호출 │
│ • 사용자 정보 조회/수정 │
│ │
│ 4️⃣ app/auth/login/page.tsx │
│ • signIn() 호출 (UI) │
│ │
│ 5️⃣ app/api/orders/route.ts │
│ • getServerSession() 호출 │
│ • 인증 검증 │
│ │
└─────────────────────────────────────────────┘
